name: Env Promotion

on:
  push:
    branches:
    - main
    path:
      #    - 'app/**/values-*.yaml

permissions:
  contents: write
  pull-requests: write

jobs:
  # detect if the last commit was from bot(pipline made it)
  detect-bot:
    runs-on: ubuntu-latest
    outputs:
      bot: ${{ steps.detect.outputs.bot }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect bot commit
      id: detect
      run: |
        chmod +x .github/actions/scripts/bot-commit.sh
        .github/actions/scripts/bot-commit.sh "bot"

  # create tag for the previous environment
  create-tag:
    needs: detect-bot
    if: needs.detect-bot.outputs.bot == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - run: |
        chmod +x .github/actions/scripts/create-tag.sh
        .github/actions/scripts/create-tag.sh      

  promote:
    needs: create-tag
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    #  Determine last tag (dev-frontend-v1.2.3)
    - name: Determine last tag
      id: tag
      run: |
        git fetch --tags
        LAST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))

        if [ -z "$LAST_TAG" ]; then
          echo "No tag found. Exiting."
          exit 0
        fi

        IFS='-' read -r ENV SERVICE VERSION_FULL <<< "$LAST_TAG"
        VERSION="${VERSION_FULL#v}"

        echo "LAST_TAG=$LAST_TAG"
        echo "ENV=$ENV" >> $GITHUB_OUTPUT
        echo "SERVICE=$SERVICE" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    #  Compute next environment
    - name: Compute next environment
      id: next-env
      run: |
        ENV="${{ steps.tag.outputs.ENV }}"
        SERVICE="${{ steps.tag.outputs.SERVICE }}"
        VERSION="${{ steps.tag.outputs.VERSION }}"

        if [[ "$ENV" == "dev" ]]; then
          NEXT_ENV="stage"
        elif [[ "$ENV" == "stage" ]]; then
          NEXT_ENV="prod"
        else
          echo "Already prod. No further promotions."
          exit 0
        fi

        BRANCH="auto/$ENV-to-$NEXT_ENV-$SERVICE"

        echo "NEXT_ENV=$NEXT_ENV" >> $GITHUB_OUTPUT
        echo "SERVICE=$SERVICE" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT

    #  Delete old branch if exists
    - name: Delete previous promotion branch
      run: |
        BRANCH="${{ steps.next-env.outputs.BRANCH }}"
        git push origin --delete $BRANCH 2>/dev/null || true

    #  Create new promotion branch
    - name: Create promotion branch
      run: |
        git checkout main
        BRANCH="${{ steps.next-env.outputs.BRANCH }}"
        git checkout -b $BRANCH

    #  Update values file for the next env and service
    - name: Update values file
      run: |
        CHART_DIR="app"
        NEXT_ENV="${{ steps.next-env.outputs.NEXT_ENV }}"
        SERVICE="${{ steps.tag.outputs.SERVICE }}"
        VERSION="${{ steps.tag.outputs.VERSION }}"
        VALUES_FILE="$CHART_DIR/values-$NEXT_ENV.yaml"

        echo "Updating $VALUES_FILE for $SERVICE to version $VERSION"

        if ! command -v yq &> /dev/null; then
          sudo wget -q https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
        fi

        if [ ! -f "$VALUES_FILE" ]; then
          echo "Error: $VALUES_FILE not found"
          exit 1
        fi

        yq e -i ".${SERVICE}.image.tag = \"v$VERSION\"" "$VALUES_FILE"

        cat "$VALUES_FILE"

    #  Commit & push branch
    - name: Commit & push branch
      run: |
        git config --global user.email "jamiekariuki18@gmail.com"
        git config --global user.name "bot"

        git add app/

        if git diff --cached --quiet; then
          echo "No changes to commit."
          exit 1
        fi

        BRANCH="${{ steps.next-env.outputs.BRANCH }}"
        git commit -m "Promote ${{ steps.tag.outputs.SERVICE }} from ${{ steps.tag.outputs.ENV }} â†’ ${{ steps.next-env.outputs.NEXT_ENV }}: ${{ steps.tag.outputs.VERSION }}"
        git push origin $BRANCH
        echo "Branch $BRANCH pushed."

    #  Create Pull Request
    - name: Create PR and tag
      run: |
        chmod +x .github/actions/scripts/create-pr.sh
        .github/actions/scripts/create-pr.sh \
          "${{ steps.next-env.outputs.BRANCH }}" \
          "${{ steps.tag.outputs.SERVICE }}" \
          "${{ steps.tag.outputs.ENV }}" \
          "${{ steps.next-env.outputs.NEXT_ENV }}" \
          "${{ steps.tag.outputs.VERSION }}" \
          "${{ secrets.HELM_REPO_PAT }}"
