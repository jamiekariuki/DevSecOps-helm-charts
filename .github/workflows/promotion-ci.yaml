name: Env Promotion

on:
  push:
    branches:
    - main

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-service:
    runs-on: ubuntu-latest
    outputs:
      service: ${{ steps.detect.outputs.service }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Detect commit author
      id: detect
      run: |
        LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
        echo "Last commit author: $LAST_AUTHOR"

        if [[ "$LAST_AUTHOR" != "jamiekariuki" ]]; then
          echo "service=none" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "service=ok" >> $GITHUB_OUTPUT
        echo "Commit is valid for promotion."

  promote:
    needs: detect-service
    if: needs.detect-service.outputs.service != 'none'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    # 1️⃣ Determine last tag (dev-frontend-v1.2.3)
    - name: Determine last tag
      id: tag
      run: |
        git fetch --tags

        LAST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))

        if [ -z "$LAST_TAG" ]; then
          echo "No tag found. Exiting."
          exit 0
        fi

        IFS='-' read -r ENV SERVICE VERSION_FULL <<< "$LAST_TAG"
        VERSION="${VERSION_FULL#v}"

        echo "LAST_TAG=$LAST_TAG"
        echo "ENV=$ENV" >> $GITHUB_OUTPUT
        echo "SERVICE=$SERVICE" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    # 2️⃣ Compute next environment
    - name: Compute next environment
      id: next-env
      run: |
        ENV="${{ steps.tag.outputs.ENV }}"
        SERVICE="${{ steps.tag.outputs.SERVICE }}"
        VERSION="${{ steps.tag.outputs.VERSION }}"

        if [[ "$ENV" == "dev" ]]; then
          NEXT_ENV="stage"
        elif [[ "$ENV" == "stage" ]]; then
          NEXT_ENV="prod"
        else
          echo "Already prod. No further promotions."
          exit 0
        fi

        BRANCH="auto/$ENV-to-$NEXT_ENV-$SERVICE"

        echo "NEXT_ENV=$NEXT_ENV" >> $GITHUB_OUTPUT
        echo "SERVICE=$SERVICE" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT

    # 3️⃣ Delete old branch if exists
    - name: Delete previous promotion branch
      run: |
        BRANCH="${{ steps.next-env.outputs.BRANCH }}"
        git push origin --delete $BRANCH 2>/dev/null || true

    # 4️⃣ Create new promotion branch
    - name: Create promotion branch
      run: |
        git checkout main
        BRANCH="${{ steps.next-env.outputs.BRANCH }}"
        git checkout -b $BRANCH

    # 5️⃣ Update values file
    - name: Update values file
      run: |
        CHART_DIR="app"
        NEXT_ENV="${{ steps.next-env.outputs.NEXT_ENV }}"
        SERVICE="${{ steps.tag.outputs.SERVICE }}"
        VERSION="${{ steps.tag.outputs.VERSION }}"
        VALUES_FILE="$CHART_DIR/values-$NEXT_ENV.yaml"

        echo "Updating $VALUES_FILE for $SERVICE to version $VERSION"

        if ! command -v yq &> /dev/null; then
          sudo wget -q https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
        fi

        if [ ! -f "$VALUES_FILE" ]; then
          echo "Error: $VALUES_FILE not found"
          exit 1
        fi

        yq e -i ".${SERVICE}.image.tag = \"$VERSION\"" "$VALUES_FILE"

        cat "$VALUES_FILE"

    # 6️⃣ Commit & push branch
    - name: Commit & push branch
      run: |
        git config --global user.email "jamiekariuki18@gmail.com"
        git config --global user.name "jamiekariuki"

        git add app/

        if git diff --cached --quiet; then
          echo "No changes to commit."
          exit 1
        fi

        BRANCH="${{ steps.next-env.outputs.BRANCH }}"
        git commit -m "Promote ${{ steps.tag.outputs.SERVICE }} from ${{ steps.tag.outputs.ENV }} → ${{ steps.next-env.outputs.NEXT_ENV }}: ${{ steps.tag.outputs.VERSION }}"
        git push origin $BRANCH
        echo "Branch $BRANCH pushed."

    # 7️⃣ Create Pull Request
    - name: Create PR
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BRANCH="${{ steps.next-env.outputs.BRANCH }}"
        SERVICE="${{ steps.tag.outputs.SERVICE }}"
        ENV="${{ steps.tag.outputs.ENV }}"
        NEXT_ENV="${{ steps.next-env.outputs.NEXT_ENV }}"
        VERSION="${{ steps.tag.outputs.VERSION }}"

        # Ensure label exists
        LABEL_CHECK=$(gh label list --search "promotion" --json name --jq '.[0].name' || echo "")

        if [ -z "$LABEL_CHECK" ]; then
          echo "Label 'promotion' not found. Creating it..."
          gh label create promotion --color FFA500 --description "Env promotion automation"
        fi

        # Check existing PR
        EXISTING_PR=$(gh pr list --head $BRANCH --base main --json number --jq '.[0].number' 2>/dev/null || echo "")

        if [ -z "$EXISTING_PR" ]; then
          gh pr create \
            --title "Promote $SERVICE: $ENV → $NEXT_ENV" \
            --body "Promoting **$SERVICE** from **$ENV** to **$NEXT_ENV**  
            
            Version: **$VERSION**" \
            --head $BRANCH \
            --base main \
            --label promotion
        else
          echo "PR #$EXISTING_PR already exists for branch $BRANCH"
        fi
