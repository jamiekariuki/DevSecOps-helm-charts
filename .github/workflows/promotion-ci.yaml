name: Env Promotion

on:
  push:
    branches:
    - main
    paths:
    - 'app/**/values-*.yaml'

permissions:
  contents: write

jobs:
  detect-service:
    runs-on: ubuntu-latest
    outputs:
      service: ${{ steps.detect.outputs.service }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Check last commit author
      id: author
      run: |
        LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
        echo "Last commit author: $LAST_AUTHOR"

        if [[ "$LAST_AUTHOR" != "Your Bot Name" ]]; then
          echo "Last commit not from bot. Stopping workflow."
          echo "service=none" >> $GITHUB_OUTPUT
          exit 0
        fi

    - name: Detect changed service
      id: detect
      run: |
        FILES=$(git diff --name-only HEAD^ HEAD)
        echo "Changed files: $FILES"

        if echo "$FILES" | grep -q "values.*frontend"; then
          echo "service=frontend" >> $GITHUB_OUTPUT
        elif echo "$FILES" | grep -q "values.*backend"; then
          echo "service=backend" >> $GITHUB_OUTPUT
        else
          echo "service=none" >> $GITHUB_OUTPUT

  promote:
    needs: detect-service
    if: needs.detect-service.outputs.service != 'none'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    # 1️⃣ Determine last tag from bot
    - name: Determine last tag
      id: tag
      run: |
        SERVICE="${{ needs.detect-service.outputs.service }}"
        git fetch --tags
        LAST_TAG=$(git tag --sort=-v:refname | grep -E "^(dev|stage|prod)-${SERVICE}-v[0-9]+\.[0-9]+\.[0-9]+$" | head -n1)

        if [ -z "$LAST_TAG" ]; then
          echo "No previous tag for $SERVICE found. Exiting."
          exit 0
        fi

        IFS='-' read -r ENV SERVICE VERSION_FULL <<< "$LAST_TAG"
        VERSION="${VERSION_FULL#v}"

        echo "ENV=$ENV" >> $GITHUB_OUTPUT
        echo "SERVICE=$SERVICE" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    # 2️⃣ Compute next environment
    - name: Compute next environment
      id: next-env
      run: |
        ENV="${{ steps.tag.outputs.ENV }}"
        SERVICE="${{ steps.tag.outputs.SERVICE }}"
        VERSION="${{ steps.tag.outputs.VERSION }}"

        if [[ "$ENV" == "dev" ]]; then
          NEXT_ENV="stage"
        elif [[ "$ENV" == "stage" ]]; then
          NEXT_ENV="prod"
        else
          echo "Already prod. Nothing to promote."
          exit 0
        fi

        echo "NEXT_ENV=$NEXT_ENV" >> $GITHUB_OUTPUT
        echo "SERVICE=$SERVICE" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    # 3️⃣ Delete previous promotion branch if exists
    - name: Delete previous promotion branch
      run: |
        BRANCH="auto/${{ steps.tag.outputs.ENV }}-to-${{ steps.next-env.outputs.NEXT_ENV }}-${{ steps.tag.outputs.SERVICE }}"

        if git ls-remote --exit-code --heads origin $BRANCH; then
          git push origin --delete $BRANCH
        fi
        if git show-ref --verify --quiet refs/heads/$BRANCH; then
          git branch -D $BRANCH
        fi

    # 4️⃣ Create new promotion branch
    - name: Create promotion branch
      run: |
        BRANCH="auto/${{ steps.tag.outputs.ENV }}-to-${{ steps.next-env.outputs.NEXT_ENV }}-${{ steps.tag.outputs.SERVICE }}"
        git checkout -b $BRANCH

    # 5️⃣ Update next environment values file
    - name: Update values file
      run: |
        CHART_DIR="helm/crud-app-chart"
        NEXT_ENV="${{ steps.next-env.outputs.NEXT_ENV }}"
        SERVICE="${{ steps.tag.outputs.SERVICE }}"
        VERSION="${{ steps.tag.outputs.VERSION }}"

        VALUES_FILE="$CHART_DIR/values-$NEXT_ENV.yaml"

        # install yq if not present
        if ! command -v yq &> /dev/null; then
          sudo wget -q https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
        fi

        yq e -i ".${SERVICE}.image.tag = \"$VERSION\"" "$VALUES_FILE"

    # 6️⃣ Commit & push branch
    - name: Commit & push branch
      run: |
        git config --global user.email "bot@github.com"
        git config --global user.name "Your Bot Name"

        git add "$CHART_DIR/values-$NEXT_ENV.yaml"

        if git diff --cached --quiet; then
          echo "No changes to commit."
          exit 0
        fi

        git commit -m "Promote $SERVICE from ${{ steps.tag.outputs.ENV }} → $NEXT_ENV: $VERSION"
        git push origin HEAD

    # 7️⃣ Create Pull Request
    - name: Create PR
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: HEAD
        base: main
        title: "Promote ${{ steps.tag.outputs.SERVICE }} ${{ steps.tag.outputs.ENV }} → ${{ steps.next-env.outputs.NEXT_ENV }}"
        body: |
          This PR promotes ${{ steps.tag.outputs.SERVICE }} from ${{ steps.tag.outputs.ENV }} to ${{ steps.next-env.outputs.NEXT_ENV }}.
        labels: promotion
